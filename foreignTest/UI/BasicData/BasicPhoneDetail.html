<!--创建人：简佳成-->
<!--创建时间：2018.12.1-->
<!--描述：基础数据类型详情页-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="../../Themes/material/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../CSS/demo.css">
    <link rel="stylesheet" type="text/css" href="../../CSS/common.css">
</head>

<body style="padding: 0px;">
<div id="toolbar" class="receipts_toolbar_style"></div>
<form id="ff">
    <table id="basicData" class="displaytable" style="text-align:right;width: 100%;table-layout:fixed">
        <tr style="height: 60px;width: 100%">
            <td style="width: 15%;"><span class="required">*</span>ContactType:</td>
            <td style="width: 35%;text-align: left;">
                <input type="text" style="width: 85%" class="easyui-combobox" data-options="required:true"
                       id="input_contactType"/>
            </td>
            <td style="width: 15%"><span class="required">*</span>Comm.Type:</td>
            <td style="text-align: left">
                <input type="text" style="width: 80%" class="easyui-combobox" id="input_communicationType" data-options="required:true"/>
            </td>
        </tr>
        <tr>
            <td >CountryPrefix:</td>
            <td style="text-align: left">
                <input type="text" style="width: 85%" class="easyui-textbox" id="input_countryPrefix"
                       data-options="validType:'gPattern[CountryPrefixRegular]'"/>
            </td>
            <td ><span class="required">*</span>Area Code + Number:</td>
            <td style="text-align: left">
                <input type="text" style="width: 80%" class="easyui-textbox" id="input_number" data-options="required:true"/>
            </td>
        </tr>

        <tr>
            <td >Extension:</td>
            <td style="text-align: left">
                <input type="text" style="width: 85%" class="easyui-textbox" id="input_extension" data-options=""/>
            </td>
            <td >Comments:</td>
            <td style="text-align: left">
                <input type="text" style="width: 80%;height: 50px" class="easyui-textbox" id="input_comments" data-options="multiline:true"/>
            </td>
        </tr>


    </table>
    <div class="submit_button">
        <a class="easyui-linkbutton" iconCls="icon-save" onclick="save()" style="width: 100px;"> Save</a>
        <a class="easyui-linkbutton" iconCls="icon-reload" onclick="cls()"
           style="width: 100px;margin-left: 10px;">Reset</a>
    </div>
</form>
<script type="text/javascript" src="../../JS/jquery.min.js"></script>
<script type="text/javascript" src="../../JS/jquery.easyui.js"></script>
<script type="text/javascript" src="../../Utils/ip.js"></script>
<script type="text/javascript" src="../../JS/common.js"></script>
<script type="text/javascript" src="../../Utils/Request.js"></script>
<script type="text/javascript" src="../../Utils/ShareComponent.js"></script>
<script type="text/javascript" src="../../JS/ToolBar.js"></script>
<script type="text/javascript" src="../../Utils/BasicList.js"></script>
<script type="text/javascript" src="../../Utils/Enum.js"></script>
</body>
<script type="text/javascript">
    var payload = JSON.parse(localStorage.getItem("customerPhone"))
    var gData = JSON.parse(localStorage.getItem("phoneData"))
    var gPersonId = localStorage.getItem("personId")
    var gEnNumRegular = /^[A-Za-z0-9\-\s]+$/;
    var gEnRegular = /^[A-Z\-]+$/;
    var gNumRegular = /^[0-9\-]+$/;
    var CountryPrefixRegular = /^([0-9a-zA-Z_]){1,4}$/
    var gApiKey = getApiKey()
    var gRequest = new RequestHandle();
    var gCurrid = Number(getID());
    var gGetPostData
    var gComboboxConfig = {//配置combobox
        panelWidth:210,
        panelHeight:180,
        //value:'I',
        onHidePanel: checkCombobox,

    }

    //构造combobox
    createComponentFactory("BASICDATA_CONTACTTYPE", '#input_contactType',gComboboxConfig);
    createComponentFactory("BASICDATA_COMMUNICATIONTYPE", '#input_communicationType',gComboboxConfig);
    $(document).ready(function () {
        if (gCurrid !== AddFlag) {
                getFormData(gData);
            }
        else {
            gCurrid = AddFlag;
        }

    });
    $.extend($.fn.validatebox.defaults.rules, {
        gPattern: {
            validator: function (value, param) {
                return param[0].test(value);
            },
            message: '错误格式!'
        }
    });
    function getApiKey() {
        switch (payload.type) {
            case "customerPhone":
                return "CUSTOMERS";
            case "entityPhone":
                return "ENTITY";
            case "entityDirectorPhone":
                return "DIRECTOR";
        }
    }

    function cls() {
        $('#ff').form('reset');
    }
    function checkCombobox() {//输入与下拉不一致返回空
        var _options = $(this).combobox('options');
        var _data = $(this).combobox('getData');
        var _value = $(this).combobox('getValue');
        var _flag = false;
        for (var i = 0; i < _data.length; i++) {
            if (_data[i][_options.valueField] == _value) {
                _flag=true;
                break;
            }
        }
        if(!_flag){
            $(this).combobox('setValue', '');
        }
    }

    function save() {
        var flag = checkInput();
        var _url;
        var _method;
        if (gCurrid == AddFlag) {
            _url = "phone/add";
            _method = "post";
        } else {
            _url = "phone/edit";
            _method = "put";
        }
        if(flag){
            saveData(_url);
        }

    }

    function saveData(_url) {
        var _data = submitFormData();
        for(var i in _data){
            if(_data[i]==""){
                delete _data[i]
            }
        }
        if (gCurrid == AddFlag) {
            var postData
            if(gApiKey==="CUSTOMERS"){
                postData= $.extend(false,_data,{personId:gPersonId});
            }else if(gApiKey==="ENTITY"){
                var _entityId = localStorage.getItem("entityId")
                postData=$.extend(false,_data,{entityId:_entityId});
            }else if(gApiKey==="DIRECTOR"){
                postData=$.extend(false,_data,{personId:gPersonId});
            }

            postData = JSON.stringify(postData)
            gRequest.postRemoteData(gApiKey,_url,postData).done(function (result) {
                if (result.code == 0) {
                    var parentLocation;
                    parentLocation = searchParent("BasicPhone.html");
                    $.messager.alert({
                        title: 'Info',
                        msg: result.msg,
                        fn: function(){
                            parentLocation.closeDlg();
                        }
                    });
                } else {
                    $.messager.alert("Info", result.msg);
                }
            });
        } else {

            var postData ;
            if(gApiKey==="CUSTOMERS"){
                postData= $.extend(false,_data,{personId:gPersonId,id:gCurrid});
            }else if(gApiKey==="ENTITY"){
                var _entityId = localStorage.getItem("entityId")
                postData=$.extend(false,_data,{entityId:_entityId,id:gCurrid});
            }else if(gApiKey==="DIRECTOR"){
                //var _entityId = localStorage.getItem("entityId")
                postData=$.extend(false,_data,{personId:gPersonId,id:gCurrid});
            }
            gRequest.putRemoteData(gApiKey,_url,postData).done(function (result) {
                if (result.code == 0) {
                    var parentLocation;
                    parentLocation = searchParent("BasicPhone.html");
                    $.messager.alert({
                        title: 'Info',
                        msg: result.msg,
                        fn: function(){
                            parentLocation.closeDlg();
                        }
                    });
                } else {
                    $.messager.alert("Info", result.msg);
                }
            });
        }
    }
</script>
</html>
