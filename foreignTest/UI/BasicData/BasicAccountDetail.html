<!--创建人：简佳成-->
<!--创建时间：2018.12.4-->
<!--描述：客户详情展示页面框架 未完成-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="../../Themes/material/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../CSS/common.css">

</head>
<body>
<div id="header">
</div>
<div style="width:100%;min-height:570px;padding:10px;background:#fafafa;">
    <form id="ff" style="width: 100%">
        <table id="sss" class="displayable" style="text-align:right;width: 100%">
            <tr style="height: 70px;width: 100%" class="show">
                <!--<td style="width: 8%;"><span class="required">*</span>Language:</td>-->
                <!--<td style="width: 25%;text-align: left;">-->
                <!--<input type="text" class="easyui-combobox" data-options='required:true'-->
                <!--style="width: 80%;height: 30px"-->
                <!--id="input_languageType"/>-->
                <!--</td>-->
                <td><span class="required">*</span>CurrencyCode:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-combobox" id="input_currencyCode" style="width: 80%;height: 30px"
                           data-options="required:true"/>
                </td>
                <td style="width: 8%"><span class="required">*</span>AccountNumber:</td>
                <td style="text-align: left;" colspan="3">
                    <input type="text" class="easyui-textbox" id="input_account" style="width:91.5%;height: 30px"
                           data-options="required:true"/>
                </td>
            </tr>

            <tr style="height: 70px" id="rowHidden">
                <td><span class="required">*</span>户名:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" name="rowHidden" class="easyui-textbox" data-options='required:true'
                           style="width: 80%;height: 30px"
                           id="input_accountNameCN"/>
                </td>
                <td><span class="required">*</span>开户银行:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" name="rowHidden" class="easyui-textbox" id="input_institutionNameCN"
                           style="width: 80%;height: 30px"
                           data-options="required:true"/>
                </td>
                <td><span class="required">*</span>开户行地址:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" name="rowHidden" class="easyui-textbox" id="input_branchCN"
                           style="width: 80%;height: 30px"
                           data-options="required:true"/>
                </td>
            </tr>
            <tr style="height: 70px" class="show">
                <td><span class="required">*</span>AccountType:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-combobox" data-options='required:true'
                           style="width: 80%;height: 30px"
                           id="input_personalAccountType"/>
                </td>
                <td><span class="required">*</span>AccountName:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" id="input_accountName" style="width: 80%;height: 30px"
                           data-options="required:true"/>
                </td>
                <td><span class="required">*</span>InstitutionName:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" id="input_institutionName" style="width: 80%;height: 30px"
                           data-options="required:true"/>
                </td>
            </tr>
            <tr style="height: 70px" class="show">
                <td><span class="required">*</span>Branch:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" data-options='required:true'
                           style="width: 80%;height: 30px"
                           id="input_branch"/>
                </td>
                <td><span class="required">*</span>SwiftCode:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox"
                           data-options="required:true,validType:'gSwiftCodePattern[gSwiftCodeRegular]'"
                           style="width: 80%;height: 30px"
                           id="input_swift"/>
                </td>

            </tr>
            <tr style="height: 70px" class="show">
                <td>Balance:</td>
                <td style="width: 25%;text-align: left">
                    <input id="yes" type="radio" value="1" name="flag" onclick="onRadioY()"/>
                    <label for="yes">Yes</label>
                    <input id="no" type="radio" value="0" name="flag" checked="checked" onclick="onRadioN()"/>
                    <label for="no">No</label>
                </td>
                <td><span class="required">*</span>StatusCode:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox"
                           data-options="required:true,validType:'gStatusCodePattern[gStatusCodeRegular]'"
                           style="width: 80%;height: 30px"
                           id="input_statusCode"/>
                </td>
                <td>beneficiary:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" id="input_beneficiary" style="width: 80%;height: 30px"
                           data-options=""/>
                </td>
            </tr>
            <tr style="height: 70px" class="show">
                <td>IBAN:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" id="input_iban" style="width: 80%;height: 30px"
                           data-options=""/>
                </td>
                <td>ClientNumber:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" data-options="" style="width: 80%;height: 30px"
                           id="input_clientNumber"/>
                </td>
                <td>opened:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-datebox" id="input_opened" style="width: 80%;height: 30px"
                           data-options=""/>
                </td>
            </tr>
            <tr style="height: 70px" class="show">
                <td>closed:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-datebox" id="input_closed" style="width: 80%;height: 30px"/>
                </td>
                <td>beneficiaryComment:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" data-options="" style="width: 80%;height: 30px"
                           id="input_beneficiaryComment"/>
                </td>
                <td class="balance"><span class="required">*</span>Balance:</td>
                <td class="balance" style="width: 25%;text-align: left">
                    <input type="text" class="easyui-numberspinner" id="input_balance" style="width: 80%;height: 30px"
                           data-options="min:0,precision:0,editable:true,required:true"/>
                </td>
            </tr>
            <tr style="height: 100px">
                <td style="padding-bottom: 60px">Comments:</td>
                <td colspan="5" style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" id="input_comments" style="width: 95%;height: 70px"
                           data-options="multiline:true"/>
                </td>
            </tr>
        </table>
        <div class="submit_button" style="margin-top: 0px">
            <a class="easyui-linkbutton" iconCls="icon-save" onclick="save()" style="width: 100px;"> Save</a>
            <a class="easyui-linkbutton" iconCls="icon-reload" onclick="cls()"
               style="width: 100px;margin-left: 10px;">Reset</a>
        </div>
    </form>
</div>
</body>
<script type="text/javascript" src="../../JS/jquery.min.js"></script>
<!--必须使用这个js而不是min.js ,因为做了封装修改-->
<script type="text/javascript" src="../../JS/jquery.easyui.js"></script>
<script type="text/javascript" src="../../JS/common.js"></script>
<script type="text/javascript" src="../../Utils/ip.js"></script>
<script type="text/javascript" src="../../Utils/ShareComponent.js"></script>
<script type="text/javascript" src="../../JS/ToolBar.js"></script>
<script type="text/javascript" src="../../JS/SearchComponent.js"></script>
<script type="text/javascript" src="../../Utils/BasicList.js"></script>
<script type="text/javascript" src="../../Utils/Request.js"></script>
<script type="text/javascript" src="../../Utils/Enum.js"></script>
<script type="text/javascript" src="../../JS/Header.js"></script>
<script type="text/javascript">
    var gCreatHeader = new creatHeader();
    var gBasicList = new BasicListPage();
    var gRequest = new RequestHandle();
    var gApiKey = "ACCOUNT";
    var gPostIdData = getIdArry();

    var payload = JSON.parse(localStorage.getItem("Account"));
    var employerAddressId = localStorage.getItem("employerAddressId");
    var gPersonId = localStorage.getItem("personId");
    var gEnNumRegular = /^[A-Za-z0-9\-\s]+$/;
    var gSwiftCodeRegular = /^[A-Za-z0-9\-\s]{0,11}$/;
    var gEnRegular = /^[A-Z\-]+$/;
    var gStatusCodeRegular = /^[A-G\-]+$/;
    var gNumRegular = /^[0-9\-]+$/;
    //validType:'gPattern[gStatusCodeRegular]'
    var gComboboxConfig = {//配置combobox
        panelWidth: 285,
        onHidePanel: checkCombobox,
    };

    var LANGUAGE_TYPE_EMNU={
        CHINA:"1",
        ENGLISH:"0",
    }
    //createComponentFactory("LANGUAGE_DATATYPE", '#input_languageType', gComboboxConfig);
    createComponentFactory("BASICDATA_ACCOUNTTYPE", '#input_personalAccountType', gComboboxConfig);
    createComponentFactory("CURRENCY_CODE", '#input_currencyCode', gComboboxConfig);
    $(document).ready(function () {
        var _res;
        if (gPostIdData.id != AddFlag) {
            _res = gRequest.putRemoteData(gApiKey, "get", gPostIdData);
            _res.done(function (data) {
                getFormData(data.data);
                if (data.data.languageType == LANGUAGE_TYPE_EMNU.CHINA) {
                    $("#rowHidden").show();
                } else {
                    $("#rowHidden").hide();
                }
                if (data.data.balanceFlag == "1") {
                    $(".balance").show();
                } else {
                    $(".balance").hide();
                }
                var _flag = $("input[value='" + data.data.balanceFlag + "']").attr('checked', 'true');
            });
        } else {
            $(".balance").hide();
            $("#input_currencyCode").combobox("setValue", "NZD");
            $("#rowHidden").hide();
            gPostIdData.id = AddFlag;
        }

    });

    $.extend($.fn.validatebox.defaults.rules, {
        gPattern: {
            validator: function (value, param) {
                return param[0].test(value);
            },
            message: 'Format error!'
        },
        gStatusCodePattern: {
            validator: function (value, param) {
                return param[0].test(value);
            },
            message: 'Please enter the letter A-G!'
        },
        gSwiftCodePattern: {
            validator: function (value, param) {
                return param[0].test(value);
            },
            message: 'The number of input characters must be between 1 and 11 bits!'
        }
    });
    $("#input_institutionName").textbox({
        onChange: function (value) {
            value = value.toUpperCase();
            if (SwiftCode[value] != undefined) {
                $(this).textbox("setValue", SwiftCode[value].name);
                $("#input_swift").textbox("setValue", SwiftCode[value].SwiftCode);
            }
        }
    });

    $("#input_currencyCode").combobox({
        onSelect: function (value) {
            if (value.currencyCode === 'RMB') {
                // $("#input_languageType").combobox('setValue', LanguageType.LANGUAGE_CHN);
                $("#rowHidden").show();
            } else {
                //   $("#input_languageType").combobox('setValue', LanguageType.LANGUAGE_LOCAL);
                $("#rowHidden").hide();
            }
        }
    });

    function onRadioY() {
        $(".balance").show();
    }

    function onRadioN() {
        $(".balance").hide();
    }

    function getIdArry() {
        var _idArry = {};
        var urlinfo = window.location.href;

        var len = urlinfo.length;
        var offset = urlinfo.indexOf("?");
        if (offset == -1) {
            return undefined;
        }
        var newsidinfo = urlinfo.substr(offset + 1, len);
        var newsids = newsidinfo.split("&");
        newsids.forEach(function (value, index) {
            var arr = value.split("=");
            _idArry[arr[0]] = arr[1];
        });
        return _idArry;
    }

    function cls() {
        $('#ff').form('reset');
    }

    function save() {
        var flag = checkInputC();
        var _url;
        var _method;
        if (gPostIdData.id == AddFlag) {
            _url = "add";
            _method = "post";
        } else {
            _url = "edit";
            _method = "put";
        }
        if (flag) {
            saveData(_url);
        }

    }

    function checkInputC() {//检查input表单值是否符合要求
        var flag = true;
        if ($("#input_currencyCode").combobox("getValue") === "RMB") {
            $("#rowHidden .easyui-textbox").each(function (index) {
                if (!$(this).textbox('isValid')) {
                    flag = false;
                    return;
                }
                ;
            });
        }
        if ($('input[name="flag"]:checked').val() == "1") {
            $(".show .easyui-numberspinner").each(function (index) {
                if (!$(this).datebox('isValid')) {
                    flag = false;
                    return;
                }
                ;
            });
        }
        $(".show .easyui-combobox").each(function (index) {
            if (!$(this).combobox('isValid')) {
                flag = false;
                return;
            }
            ;
        });


        $(".show .easyui-datebox").each(function (index) {
            if (!$(this).datebox('isValid')) {
                flag = false;
                return;
            }
            ;
        });

        if (!flag) {
            $.messager.alert("Info", "Format error, not saved！");
        }
        return flag;
    }

    function saveData(_url) {
        var _data = submitFormData();
        _data.account = delSpace(_data.account);
        _data.swift = delSpace(_data.swift);
        _data.clientNumber = delSpace(_data.clientNumber);
        console.log(_data);
        // _data.closed=new Date(_data.closed).format("yyyy-MM-dd").toString();
        // _data.opend=new Date(_data.closed).format("yyyy-MM-dd").toString();
        var _flag = $('input[name="flag"]:checked').val();
        var postData = {};
        postData.nonBankInstitution = "2";
        postData.codeOrSwift = "0";
        if (_data.currencyCode !== "RMB") {
            postData.institutionNameLocal = "1";
            postData.languageType=LANGUAGE_TYPE_EMNU.ENGLISH;
            delete _data.accountNameCN;
            delete _data.branchCN;
            delete _data.institutionNameCN;
        } else if (_data.currencyCode === "RMB") {
            postData.institutionNameChn = "1";
            postData.languageType=LANGUAGE_TYPE_EMNU.CHINA;
        }
        postData = $.extend(false, _data, postData);

        if (gPostIdData.id == AddFlag) {
            postData = $.extend(false, postData, {balanceFlag: _flag, id: 1, customerId: payload.id});
            for (var i in postData) {
                if (postData[i] == "") {
                    delete postData[i];
                }
            }
            postData = JSON.stringify(postData);
            gRequest.postRemoteData(gApiKey, _url, postData).done(function (result) {
                if (result.code == 0) {
                    $.messager.alert({
                        title: 'Info',
                        msg: result.msg,
                        fn: function () {
                            gPostIdData.id = result.data;
                            var pLocation = "UI/BasicData/BasicAccountDetail.html?id=" + gPostIdData.id + "&parentId=" + payload.id;
                            AddTabIn("AccountDetail", parent.$('#tabs'), pLocation);
                        }
                    });
                } else {
                    $.messager.alert("Info", result.msg);
                }
            });
        } else {
            postData = $.extend(false, postData, {
                balanceFlag: _flag,
                id: gPostIdData.id,
                customerId: gPostIdData.parentId
            });
            gRequest.putRemoteData(gApiKey, _url, postData).done(function (result) {
                if (result.code == 0) {
                    $.messager.alert("Info", result.msg);
                } else {
                    $.messager.alert("Info", result.msg);
                }
            });
        }
    }

</script>
</html>
