<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../../Themes/material/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../CSS/common.css">
    <link rel="stylesheet" type="text/css" href="../../CSS/BasicDataPreview.css">
</head>
<body style="overflow-x:hidden">
<div id="div_displayStatus" style="display: flex;justify-content:flex-end;margin-right: 2%;margin-bottom: 1%">
    <div id="toolbar1" style="margin-bottom: 10px;padding:10px;width:100px;margin-right: 80%">
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save'"
           onclick="saveTransaction()">Save</a>
    </div>
    <span id="span_status" class="span_status"></span>
</div>
<div id="p" class="easyui-panel" title="CustomerInfo"
     style="width:98%;height:120px;padding:10px;background:#fafafa;overflow: hidden"
     data-options="iconCls:'icon-save',closable:false,minimizable:false,maximizable:false,selected:true,collapsible:true,collapsed:true">
    <div id="div_content" style="width: 80%;height:100px"></div>
</div>
<div id="edit" class="easyui-panel" title="IdentityInfo"
     style="width:98%;height:250px;padding:10px;background:#fafafa;overflow: hidden"
     data-options="iconCls:'icon-save',
    collapsible:true,collapsed:true,minimizable:false,maximizable:false,tools:'#indentityInfoEdit',loadingMessage : '加载中...'">
    <div id="indentityInfoEdit">
        <a class="icon-edit" id="identityInfoButton" onclick="editIndentityInfo()"></a>
    </div>
    <table id='table_identity' style="height: auto;"></table>
</div>
<div class="easyui-panel" title="Address"
     style="width:98%;height:250px;padding:10px;background:#fafafa;overflow: hidden"
     data-options="iconCls:'icon-save',closable:false,
    collapsible:true,collapsed:true,minimizable:false,maximizable:false,tools:'#addressInfoEdit',selected:false">
    <div id="addressInfoEdit">
        <a class="icon-edit" id="addressInfoButton" onclick="editAddressInfo()"></a>
    </div>
    <table id='table_address' style="height: auto;"></table>
</div>
<div id="TransactionInfo" class="easyui-panel" title="TransactionInfo"
     style="width:98%;height:240px;padding:10px;background:#fafafa;overflow: hidden"
     data-options="iconCls:'icon-save',closable:false,minimizable:false,maximizable:false,selected:false,collapsible:true">
    <form id="ff_transactionInfo" style="width: 100%">
        <table class="displayable" style="text-align:right;width: 100%">
            <tr style="height: 60px;width: 100%">
                <td style="width: 8%;">TransactionNumber:</td>
                <td style="width: 25%;text-align: left;">
                    <input type="text" class="easyui-textbox" style="width: 80%;" disabled='disabled'
                           id="input_transactionNumber"/>
                </td>
                <td style="width: 8%"><span class="required">*</span>TransactionDate:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-datebox" id="input_dateTransaction" style="width: 80%;"
                           data-options="required:true"/>
                </td>
                <td style="width: 8%"><span class="required">*</span>Visible</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-combobox" id="input_visible" style="width: 80%;"
                           data-options="required:true,value:'1'"/>
                </td>
            </tr>
            <tr style="height: 60px;width: 100%">
                <td style="width: 8%;"><span class="required">*</span>TransmodeCode:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-combobox" style="width: 80%;"
                           id="input_transmodeCode"/>
                </td>
                <td style="width: 8%;"><span class="required">*</span>LocalRate:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-numberbox" id="input_localRate" style="width: 80%;"
                           data-options="required:true,precision:3"/>
                </td>
                <td><span class="required">*</span>AmountLocal:</td>
                <td style="width: 25%">
                    <div style="display: flex">
                        <input type="text" class="easyui-numberbox" id="input_amountLocal" style="width: 82%"
                               data-options="required:true,precision:4"/>
                        <a class="easyui-linkbutton"
                           style="width: 20%;margin-left:2%;color: #fff;background-color: #0088ec"
                           onclick="calculate()">calculate</a>
                    </div>
                </td>
            </tr>
        </table>
        <div style="margin-bottom: 20px">
            <p style="display: inline-block;margin-left: 1px">transactionDescription:</p>
            <input type="text" class="easyui-textbox" id="input_transactionDescription"
                   style="width: 86%"/>
        </div>
    </form>
    <div id="div_content3" style="width: 80%;height:120px;display: none;"></div>
</div>
<div id="fromClient" class="easyui-panel" title="FromClient"
     style="width:98%;height:550px;padding:10px;background:#fafafa;overflow: hidden"
     data-options="iconCls:'icon-save',closable:false,
    collapsible:true,minimizable:false,maximizable:false">
    <form id="ff_formClient" style="width: 100%">
        <table class="displayable" style="text-align:right;width: 100%">
            <tr style="height: 60px;width: 100%">
                <td style="width: 8%;"><span class="required">*</span>FromCurrencyCode:</td>
                <td style="width: 25%;text-align: left;">
                    <input type="text" class="easyui-textbox" style="width: 80%;"
                           id="input_fromCurrencyCode" data-options="required:true"/>
                </td>
                <td style="width: 8%"><span class="required">*</span>FromAmount:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-numberbox" id="input_fromAmount" style="width: 80%;"
                           data-options="required:true,precision:4"/>
                </td>
            </tr>
            <tr style="height: 60px">
                <td><span class="required">*</span>ExchangeRate:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-textbox" id="input_exchangeRate" style="width: 80%;"
                           data-options="required:true"/>
                </td>
                <td style="width:25%;text-align: left">
                    <a class="easyui-linkbutton"
                       style="width:40px;background-color: #0088ec;display: inline-block;color: #fff"
                       onclick="mult()">×</a>
                    <a class="easyui-linkbutton"
                       style="width:40px;background-color: #0088ec;display: inline-block;color: #fff"
                       onclick="division()">÷</a>
                    <a class="easyui-linkbutton"
                       style="width: 60px;background-color: #0088ec;display: inline-block;color: #fff"
                       onclick="checkCombobox()">Check</a>
                </td>
            </tr>
        </table>
        <div style="margin-bottom: 20px">
            <p style="display: inline-block;margin-left: 75px">Comments:</p>
            <input type="text" class="easyui-textbox" id="input_fromFundsComment" style="width:84%"/>
        </div>
        <div class="easyui-panel" title="Data" style="width:100%;height:255px;overflow-x:hidden">
            <div id="fromClientToolBar">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:'false'"
                   onclick="newData('#fromClientDlg')" style="width: 70px">Create</a>
                <a class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:'false'"
                   onclick="destroy('#fromClientDlg')" style="width: 70px">remove</a>
                <!--<a class="easyui-linkbutton" data-options="iconCls:'icon-information',plain:'false'"-->
                <!--onclick="upload('#dg')" style="width:70px">upload</a>-->
            </div>
            <table id="fromClientDlg"
                   style="height: auto;"></table>
        </div>
    </form>
</div>
<div id="toClient" class="easyui-panel" title="toClient"
     style="width:98%;height:500px;padding:10px;background:#fafafa;overflow: hidden"
     data-options="iconCls:'icon-save',closable:false,
    collapsible:true,minimizable:false,maximizable:false">
    <form id="ff_toClient" style="width: 100%">
        <table class="displayable" style="text-align:right;width: 100%;margin-bottom: 5px">
            <tr style="height: 60px;width: 100%;">
                <td style="width: 8%;"><span class="required">*</span>ToCurrencyCode:</td>
                <td style="width: 25%;text-align: left;">
                    <input type="text" class="easyui-combobox" style="width: 80%;"
                           id="input_toCurrencyCode" data-options="required:true"/>
                </td>
                <td style="width: 8%"><span class="required">*</span>toAmount:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-numberbox" id="input_toAmount" style="width: 80%;"
                           data-options="required:true,precision:4"/>
                </td>
            </tr>
        </table>
        <div style="margin-bottom: 20px">
            <p style="display: inline-block;margin-left: 75px">Comments:</p>
            <input type="text" class="easyui-textbox" id="input_toFundsComment" style="width:84%"/>
        </div>
        <div class="easyui-panel" title="Data" style="width:100%;height:255px;overflow-x:hidden">
            <div id="toClientToolBar">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:'false'"
                   onclick="newData('#toClientDlg')" style="width: 70px">Create</a>
                <a class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:'false'"
                   onclick="destroy('#toClientDlg')" style="width: 70px">remove</a>
            </div>
            <table id="toClientDlg"
                   style="height: auto;"></table>
        </div>
    </form>
</div>
<div id="serviceFree" class="easyui-panel" title="Service Fee"
     style="width:98%;height:120px;padding:10px;background:#fafafa;overflow: hidden"
     data-options="iconCls:'icon-save',closable:false,minimizable:false,maximizable:false,collapsible:true">
    <form id="ff_serviceFree" style="width: 100%">
        <table class="displayable" style="text-align:right;width: 100%">
            <tr style="height: 60px;width: 100%">
                <td style="width: 8%"><span class="required">*</span>CompanyAccount:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-combobox" id="input_companyAccountId" style="width: 80%;"
                           data-options="required:true"/>
                </td>
                <td style="width: 8%;"><span class="required">*</span>PaymentType:</td>
                <td style="width: 25%;text-align: left;">
                    <input type="text" class="easyui-combobox" style="width: 80%;"
                           id="input_payment" data-options="required:true"/>
                </td>
                <td style="width: 8%"><span class="required">*</span>ServiceAmount:</td>
                <td style="width: 25%;text-align: left">
                    <input type="text" class="easyui-numberbox" id="input_amount" style="width: 80%;"
                           data-options="required:true"/>
                </td>
            </tr>
        </table>
    </form>
</div>
<div id="dlg" class="easyui-dialog" closed="true">
    <iframe id="ifrmEdit" height="100%" width="100%" frameborder="0" scrolling="no"></iframe>
</div>
<script type="text/javascript" src="../../JS/jquery.min.js"></script>
<script type="text/javascript" src="../../JS/jquery.easyui.js"></script>
<script type="text/javascript" src="../../JS/common.js"></script>
<script type="text/javascript" src="../../Utils/ip.js"></script>
<script type="text/javascript" src="../../Utils/ShareComponent.js"></script>
<script type="text/javascript" src="../../JS/ToolBar.js"></script>
<script type="text/javascript" src="../../Utils/BasicList.js"></script>
<script type="text/javascript" src="../../Utils/BasicPreview.js"></script>
<script type="text/javascript" src="../../Utils/Request.js"></script>
<script type="text/javascript" src="../../Utils/Enum.js"></script>
<script type="text/javascript" src="../../JS/SearchComponent.js"></script>
<script type="text/javascript" src="../../JS/Header.js"></script>
<script type="text/javascript" src="../../Utils/BasicDetail.js"></script>
<script type="text/javascript" src="../../JS/jquery.edatagrid.js"></script>
<script type="text/javascript" src="./ReceiptDetailCommon.js"></script>
<script type="text/javascript">
    var gRequest = new RequestHandle();
    var gUpdateData = {};
    var gDealKey = "DEAL";
    var gCustomersKey = "CUSTOMERS";
    var gCurrid = getID();
    var gRateStatus = RateStatus.neither;
    var gFromClientSelect = -1;//初始没选择为-1
    var gToClientSelect = -1;

    init();

    $(document).ready(function () {
        var _sendData = {customerNumber: gCurrid};
        if (gCurrid[0] == "C") {
            _sendData = JSON.stringify(_sendData);
            $('#input_dateTransaction').datebox('setValue', initDate(new Date()));//新增的话默认日期为当天
            gRequest.postRemoteData(gCustomersKey, "allbrif", _sendData).done(function (_result) {
                getPersonBasicInfo(_result);
            });
            gRequest.putRemoteData(gDealKey, "getnum").done(function (_result) {
                $("#input_transactionNumber").textbox('setValue', _result.data);
            });
        } else {
            var _customerNumber;
            _sendData = {id: gCurrid};
            gRequest.putRemoteData(gDealKey, "get", _sendData).done(function (_result) {
                if (_result.code === 0) {
                    //gUpdateData = deepCopy(_result.data);
                    gUpdateData = JSON.parse(JSON.stringify(_result.data));
                    _result.data = convertDateData(_result.data, "/");
                    _result.data = convertFormData(_result.data, gConvertData);
                    getFormData(_result.data, true, gFormList);
                    setServiceFee(_result.data.serviceFee);
                    //展示FromClient表格数据
                    changeValueToText(_result.data.fromClients, gConvertGridData.fromClients);
                    var _obj = {"total": _result.data.fromClients.length, "rows": _result.data.fromClients};
                    $('#fromClientDlg').datagrid('loadData', _obj);
                    //展示toClient表格数据
                    changeValueToText(_result.data.toClients, gConvertGridData.toClients);
                    _obj = {"total": _result.data.toClients.length, "rows": _result.data.toClients};
                    $('#toClientDlg').datagrid('loadData', _obj);
                    _customerNumber = _result.data.customerNumber;
                    _sendData = {customerNumber: _customerNumber};
                    _sendData = JSON.stringify(_sendData);
                    gRequest.postRemoteData(gCustomersKey, "allbrif", _sendData).done(function (_result) {
                        getPersonBasicInfo(_result);
                    });
                    setStatus(_result.data);
                }
            });
        }
    });

    function init() {
        gUpdateData.fromClients = [];
        gUpdateData.toClients = [];
        createComponentFactory("RECEIPT_VISIBLE", '#input_visible', gComboboxConfig);
        createComponentFactory("RECEIPT_TRANSMODECODE", '#input_transmodeCode', gComboboxConfig);
        createComponentFactory("BASICDATA_CURRENCIES", '#input_fromCurrencyCode', gComboboxConfig);
        createComponentFactory("BASICDATA_CURRENCIES", '#input_toCurrencyCode', gComboboxConfig);
        createComponentFactory("RECEIPT_PAYMENTTYPE", '#input_payment', gComboboxConfig);
        createComponentFactory("REPORT_ACCOUNT_COMPANY", '#input_companyAccountId',  gComponyAccountConfig);

        createDataGrid(extendConfig(gConfig, "#fromClientDlg", 'fromClients'), "#fromClientDlg", '#fromClientToolBar');
        $('#fromClientDlg').datagrid('hideColumn', 'id');
        createDataGrid(extendConfig(gConfig, "#toClientDlg", 'toClients'), "#toClientDlg", '#toClientToolBar');
        $('#toClientDlg').datagrid('hideColumn', 'id');
        createDataGrid(gIdentityConfig, "#table_identity");
        createDataGrid(gAddressConfig, "#table_address");
        bundleEvent();
        addToolTips();
    }

    function getPersonBasicInfo(result) {
        localStorage.setItem("customerInfo", JSON.stringify(result.data[0]));
        createPreview(gConfigCustomerInfo, "#div_content", "local", "customerInfo");
        gUpdateData.personId = result.data[0].personId;
        gUpdateData.phoneNumber = result.data[0].phoneNumber;
        var _sendData = {id: result.data[0].personId, type: "customerIdent"};
        gRequest.putRemoteData(gCustomersKey, "ident/list", _sendData).done(function (_result) {
            localStorage.setItem("customerIdent", JSON.stringify(_result.data[0]));
            var _obj = {"total": _result.data.length, "rows": _result.data};
            $('#table_identity').datagrid('loadData', _obj);
        });
        _sendData = {id: result.data[0].personId, type: "customerAddress"};
        gRequest.putRemoteData(gCustomersKey, "addr/list", _sendData).done(function (_result) {
            localStorage.setItem("customerAddress", JSON.stringify(_result.data[0]));
            var _obj = {"total": _result.data.length, "rows": _result.data};
            $('#table_address').datagrid('loadData', _obj);
        });
        getCustomerInfo(result);
    }

    function getCustomerInfo(result) {
        //用customerId去拿accountId
        gUpdateData.customerId = result.data[0].id.toString();
        gRequest.putRemoteData(gAccountKey, "list", {id: result.data[0].id.toString()}).done(function (_result) {
            gUpdateData.accountId = _result.data[0].id;
        });
        gRequest.putRemoteData(gAccountKey, "list", {id: result.data[0].id.toString()}).done(function (_result) {
            localStorage.setItem('currentAccount', JSON.stringify(_result.data));
        });
        gRequest.putRemoteData(gEntityKey, "list", {id: result.data[0].id.toString()}).done(function (_result) {
            localStorage.setItem('currentEntity', JSON.stringify(_result.data));
        });
    }

    function bundleEvent() {
        $("#input_fromCurrencyCode").combobox({
            onSelect: function (record) {
                if (record.code === 'NZD') {
                    gRateStatus = RateStatus.NZDIsFrom;
                    RateStatus[gRateStatus]($("#input_fromAmount").textbox('getValue'));
                    return;
                }
                gRateStatus = RateStatus.neither;
            }
        });
        $("#input_toCurrencyCode").combobox({
            onSelect: function (record) {
                if (record.code === 'NZD') {
                    gRateStatus = RateStatus.NZDisTo;
                    RateStatus[gRateStatus]($("#input_toAmount").textbox('getValue'));
                    return;
                }
                gRateStatus = RateStatus.neither;
            }
        });
        $("#input_localRate").numberbox({
            onChange: function (newValue, oldValue) {
                // var value = calculate();
                // RateStatus[gRateStatus](value);
            }
        });
    }

    function saveTransaction() {
        gFormList.forEach(function (current) {
            var currentFormData = submitFormData(current);
            Object.keys(currentFormData).forEach(function (filed) {
                if (gConvertFieldData[filed]) {
                    currentFormData[filed] = typeof currentFormData[filed] === 'number' ? currentFormData[filed] : window['parse' + gConvertFieldData[filed]](currentFormData[filed]);
                }
            });
            gUpdateData = mergeUpdateData(gUpdateData, currentFormData);
        });
        mergeGrid('#fromClientDlg');
        mergeGrid('#toClientDlg');
        gUpdateData.serviceFee = addBasicInfo([gUpdateData.serviceFee], gSerViceDataList, true)[0];
        gUpdateData.serviceFee = changeTextToValue([gUpdateData.serviceFee], gConvertGridData.serviceFee)[0];
        gUpdateData = convertDateData(gUpdateData, '-');
        gUpdateData = convertFormData(gUpdateData, gConvertData, true);
        var _sendData = gUpdateData;
        if (!(checkAmount('#fromClientDlg', '#input_fromAmount') && checkAmount('#toClientDlg', '#input_toAmount'))) {
            alertMsg('please check Amount');
            return;
        }
        delete _sendData.customerNumber;//后台不接收此字段
        return gUpdateData.id !== undefined ? editTransaction(_sendData) : addTransaction(_sendData);
    }

    function addTransaction(sendData) {
        var _sendData = JSON.stringify(sendData);
        gRequest.postRemoteData(gDealKey, "add", _sendData).done(function (_result) {
            if (_result.code === 0) {
                $.messager.confirm('Info', 'add data success!', function (r) {
                    if (r) {
                        freshPage(_result.data);
                    }
                });
            } else {
                $.messager.alert('Alert', 'add data failed!' + _result.msg);
            }
        });
    }

    function editTransaction(sendData) {
        gRequest.putRemoteData(gDealKey, "edit", sendData).done(function (_result) {
            if (_result.code === 0) {
                $.messager.confirm('Info', 'save data success!', function (r) {
                    if (r) {
                        freshPage(_result.data);
                    }
                });
            } else {
                $.messager.alert('Alert', 'save data failed!', _result.msg);
            }
        });
    }

    function freshPage(data) {
        var _pLocation = "UI/Transaction/ReceiptDetail.html?id=" + (data || gCurrid);
        AddTabIn("ReceiptDetail", parent.$('#tabs'), _pLocation);
    }

    function newData(element) {
        var _pLocation = "UI/Transaction/ReceiptForm.html?";
        _pLocation += "rowIndex=" + -1 + "&gridId=" + element;
        $("#ifrmEdit").attr("src", _pLocation);
        constructDialog($('#dlg'), "update", 400, 270);
        AddDialog.dialog('open');
    }

    function destroy(element) {
        var index = "";
        switch (element) {
            case "#fromClientDlg":
                if (gFromClientSelect >= 0) {
                    $.messager.confirm('Info', 'Are you sure you want to delete this data?', function (r) {
                        if (r) {
                            index = gFromClientSelect;
                            gFromClientSelect = -1;
                            $(element).datagrid('deleteRow', index);
                        }
                    });
                } else {
                    alertMsg('please check selection');
                }
                break;
            case "#toClientDlg":
                if (gToClientSelect >= 0) {
                    $.messager.confirm('Info', 'Are you sure you want to delete this data?', function (r) {
                        if (r) {
                            index = gToClientSelect;
                            gToClientSelect = -1;
                            $(element).datagrid('deleteRow', index);
                        }
                    });
                } else {
                    alertMsg('please check selection');
                }
                break;
            default:
                break;
        }
    }

    function updateGridData(gridId) {
        var _pLocation = "UI/Transaction/ReceiptForm.html?";
        if (gFromClientSelect >= 0 || gToClientSelect >= 0) {
            switch (gridId) {
                case "#fromClientDlg":
                    _pLocation += "rowIndex=" + gFromClientSelect + "&gridId=" + "#fromClientDlg";
                    break;
                case "#toClientDlg":
                    _pLocation += "rowIndex=" + gToClientSelect + "&gridId=" + "#toClientDlg";
                    break;
                default:
                    break;
            }
            $("#ifrmEdit").attr("src", _pLocation);
            constructDialog($('#dlg'), "update", 400, 270);
            AddDialog.dialog('open');
        } else {
            alertMsg('please check selection');
        }
    }

    function getRow(grid, id) {
        var currentRow = deepCopy($(grid).datagrid('getSelected'));
        JSON.parse(localStorage.getItem('currentAccount')).forEach(function (current) {
            if (currentRow.accountId == current.id) {
                currentRow.accountId = current.accountName;
            }
        });
        return currentRow;
    }

    function reloadGridData(grid, data, rowId, realId) {
        var originData = deepCopy($(grid).datagrid('getRows'));
        changeUpdateData(grid, data, rowId, realId);
        if (rowId == -1) {
            data.transactionId = gUpdateData.id || 1;//有transactionId执行更新
            data.personId = gUpdateData.personId;
            data.customerId = gUpdateData.customerId;
            // data.accountId = gUpdateData.accountId;
            originData.push(data);
        } else {
            originData[rowId] = data;
        }
        $(grid).datagrid('loadData', originData);
    }

    function changeUpdateData(grid, data, rowId, realId) {
        var myConvertData = deepCopy(gConvertData);
        myConvertData.accountId = {src: 'currentAccount', key: 'id', value: 'accountName'};
        var _data = convertFormData(data, myConvertData, true);
        switch (grid) {
            case "#fromClientDlg":
                if (rowId != -1) {
                    gUpdateData.fromClients = gUpdateData.fromClients.map(function (current) {
                        if (current.id == realId) {
                            _data.transactionId = gUpdateData.id;//有transactionId执行更新
                            _data.id = realId;//这条记录真实的id
                            _data.personId = gUpdateData.personId;
                            _data.accountId = gUpdateData.accountId;
                            current = _data;
                        }
                        return current;
                    });
                }
                break;
            case "#toClientDlg":
                if (rowId != -1) {
                    gUpdateData.toClients = gUpdateData.toClients.map(function (current) {
                        if (current.id == realId) {
                            _data.transactionId = gUpdateData.id;//有transactionId执行更新
                            _data.id = realId;//这条记录真实的id
                            _data.personId = gUpdateData.personId;
                            //data.accountId = gUpdateData.accountId;
                            current = _data;
                        }
                        return current;
                    });
                }
                break;
            default:
                break;
        }
    }

    function mergeGrid(gridId) {
        var gridData = $(gridId).datagrid('getRows');
        var myConvertData = deepCopy(gConvertData);
        switch (gridId) {
            case "#fromClientDlg":
                myConvertData.accountId = {src: 'companyAccount', key: 'id', value: 'name'};
                for (var i in gUpdateData.fromClients) {
                    if (gUpdateData.fromClients.hasOwnProperty(i)) {
                        if (!gridData.some(function (current) {
                            return gUpdateData.fromClients[i].id == current.id;
                        })) {//现在的table中，不存在之前的那个Id，说明是删除
                            delete gUpdateData.fromClients[i].transactionId;
                        }
                        if (gUpdateData.fromClients[i].id === undefined) {
                            gUpdateData.fromClients.splice(i, 1);//把不是原始数据的数据删除掉，避免二次保存时重复
                        }
                    }
                }
                gridData.forEach(function (current) {
                    if (current.id === undefined) {
                        current = convertFormData(current, myConvertData, true);
                        gUpdateData.fromClients.push(current);
                    }
                });//将新增记录push到更新数据中
                break;
            case "#toClientDlg":
                myConvertData.accountId = {src: 'currentAccount', key: 'id', value: 'accountName'};
                for (var i in gUpdateData.toClients) {
                    if (gUpdateData.toClients.hasOwnProperty(i)) {
                        if (!gridData.some(function (current) {
                            return gUpdateData.toClients[i].id == current.id;
                        })) {//说明是删除
                            delete gUpdateData.toClients[i].transactionId;
                        }
                        if (gUpdateData.toClients[i].id === undefined) {
                            gUpdateData.toClients.splice(i, 1);//把不是原始数据的数据删除掉，避免二次保存时重复
                        }
                    }
                }
                gridData.forEach(function (current) {
                    if (current.id === undefined) {
                        current = convertFormData(current, myConvertData, true);
                        gUpdateData.toClients.push(current);
                    }
                });//将新增记录push到更新数据中
                break;
            default:
                break;
        }
    }

    function checkAmount(gridId, amountId) {
        var amount = $(amountId).numberbox('getValue');
        var money = 0;
        switch (gridId) {
            case "#fromClientDlg":
                gUpdateData.fromClients.forEach(function (current) {
                    if (current.transactionId !== undefined) {
                        money += current.foreignAmount;
                    }
                });
                break;
            case "#toClientDlg":
                gUpdateData.toClients.forEach(function (current) {
                    if (current.transactionId !== undefined) {
                        money += current.foreignAmount;
                    }
                });
                break;
            default:
                break;
        }
        console.log(money);
        console.log(amount);
        return money == amount;
    }

</script>
</body>
</html>
