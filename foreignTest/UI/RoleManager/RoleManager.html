<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../../Themes/material/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../CSS/common.css">
</head>

<body style="padding: 0px;">
<div id="toolbar" class="receipts_toolbar_style"></div>
<ul id="tt"></ul>
</body>
<script type="text/javascript" src="../../JS/jquery.min.js"></script>
<script type="text/javascript" src="../../JS/jquery.easyui.js"></script>
<script type="text/javascript" src="../../JS/common.js"></script>
<script type="text/javascript" src="../../JS/ToolBar.js"></script>
<script type="text/javascript" src="../../Utils/ip.js"></script>
<script type="text/javascript" src="../../Utils/ShareComponent.js"></script>
<script type="text/javascript" src="../../JS/SearchComponent.js"></script>
<script type="text/javascript" src="../../Utils/BasicList.js"></script>
<script type="text/javascript" src="../../Utils/Request.js"></script>
<script type="text/javascript" src="../../Utils/Enum.js"></script>
<script type="text/javascript">
    var ids = getMultiID();
    var currRoleName = ""; //当前角色名称
    var currRoleID = ids.ID; //当前角色ID
    var updateData = new Object();
    var globalApiKey = "ROLE";
    var globalPermissionKey = "PERMISSION";
    var gRequest = new RequestHandle();
    //iniUpdateData();
    $(document).ready(function () {
        var _ids = getMultiID();
        currRoleID = _ids.id;
        getRemoteData(currRoleID);
    });
    var receipts_type = RECEIPT_SAVE_SYMBOL;
    content = AddReceiptsToolBar(receipts_type, "");
    $("#toolbar").append(content);

    function save() {
        SaveData();
    }

    function SaveData() {
        var node = $('#tt').tree('getChecked', ['checked', 'indeterminate']);
        var permissionIds = [];
        for (var i of node) {
            permissionIds.push(i.id);
        }
        // var data = {};
        var _sendData = {
            permissionIds: permissionIds,
            roleId: currRoleID,
        };
        gRequest.putRemoteData("ROLE", "set", _sendData).complete(function (result) {
            var _result = result.responseJSON;
            if (_result.code === 0) {
                var parentLocation;
                parentLocation = searchParent("RoleManagerList.html");
                parentLocation.dialogClose();
            } else {
                $.messager.alert("Failed", _result.msg);
            }
        });
    }

    function getRemoteData(data) {
        var _sendData = {
            roleId: currRoleID,
        };

        var request_role = function () {
            var _dfd = $.Deferred();
            gRequest.getRemoteData(globalPermissionKey, "role", _sendData).complete(function (result) {
                var _result = result.responseJSON;
                if (_result.code === 0) {
                    _dfd.resolve(_result.data);
                } else {
                    _dfd.reject();
                }
            });
            return _dfd.promise();
        };

        var request_tree = function () {
            var _dfd = $.Deferred();
            gRequest.getRemoteData(globalPermissionKey, "menu/tree").complete(function (result) {
                var _result = result.responseJSON;
                if (_result.code === 0) {
                    _dfd.resolve(_result.data);
                } else {
                    _dfd.reject();
                }
            });
            return _dfd.promise();
        };

        $.when(request_role(), request_tree())
            .done(function (role, tree) {
                createRoleTreeData(tree);
                permissionToTree(tree, role);
                $("#tt").tree({
                    data: tree,
                    animate: true,
                    checkbox: true,
                    // cascadeCheck:false

                });
            })
            .fail(function () {
                $.messager.alert("Failed", data.msg);
            });
    }

</script>
